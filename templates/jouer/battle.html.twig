{% extends 'base.html.twig' %}

{% block title %}Résultat de la bataille{% endblock %}

{% block body %}
<img src="{{ asset('bottom.png') }}" alt="Décoration" class="form-page-decoration">
<div class="match-page">
    <div class="players-names">
        <span class="player-name gold-animated">{{ app.user.username }}</span>
        <span class="vs-label">VS</span>
        {% if opponent %}
            <span class="player-name gold-animated">{{ opponent.username }}</span>
        {% endif %}
    </div>
    <div class="team-avatars">
        {# Team 1: tanks #}
        {% set tanks1 = my_team|filter(c => c.role and c.role.name|lower == 'tank') %}
        {% for tank in tanks1 %}
            <div class="avatar-container team1-tank{% if loop.index0 > 0 %} offset-{{ loop.index0 }}{% endif %}" id="char-L{{ tank.id }}">
                <div class="avatar-info">
                    <div class="avatar-hp-bar">
                        <div class="avatar-hp-fill" id="hp-bar-L{{ tank.id }}" style="width:100%"><span class="avatar-hp" id="hp-L{{ tank.id }}">{{ tank.HP }}</span></div>
                    </div>
                </div>
                <img src="{{ asset('uploads/images/' ~ tank.imageName) }}" alt="{{ tank.name }}" class="avatar" title="{{ tank.name }}">
                {% if equipped_weapons[tank.id] is defined %}
                    <img src="{{ asset('uploads/weapons/' ~ equipped_weapons[tank.id].imageName) }}" 
                         alt="{{ equipped_weapons[tank.id].name }}" 
                         class="weapon-icon" 
                         title="{{ equipped_weapons[tank.id].name }} (+{{ equipped_weapons[tank.id].power }} ATK, +{{ equipped_weapons[tank.id].defense }} DEF)">
                {% endif %}
            </div>
        {% endfor %}
        {# Team 1: dps #}
        {% set dps1 = my_team|filter(c => c.role and c.role.name|lower in ['dps','damage']) %}
        {% for dps in dps1 %}
            <div class="avatar-container team1-dps{% if loop.index0 > 0 %} offset-{{ loop.index0 }}{% endif %}" id="char-L{{ dps.id }}">
                <div class="avatar-info">
                    <div class="avatar-hp-bar">
                        <div class="avatar-hp-fill" id="hp-bar-L{{ dps.id }}" style="width:100%"><span class="avatar-hp" id="hp-L{{ dps.id }}">{{ dps.HP }}</span></div>
                    </div>
                </div>
                <img src="{{ asset('uploads/images/' ~ dps.imageName) }}" alt="{{ dps.name }}" class="avatar" title="{{ dps.name }}">
                {% if equipped_weapons[dps.id] is defined %}
                    <img src="{{ asset('uploads/weapons/' ~ equipped_weapons[dps.id].imageName) }}" 
                         alt="{{ equipped_weapons[dps.id].name }}" 
                         class="weapon-icon" 
                         title="{{ equipped_weapons[dps.id].name }} (+{{ equipped_weapons[dps.id].power }} ATK, +{{ equipped_weapons[dps.id].defense }} DEF)">
                {% endif %}
            </div>
        {% endfor %}
        {# Team 1: heals #}
        {% set heals1 = my_team|filter(c => c.role and c.role.name|lower in ['heal','healer']) %}
        {% for heal in heals1 %}
            <div class="avatar-container team1-heal{% if loop.index0 > 0 %} offset-{{ loop.index0 }}{% endif %}" id="char-L{{ heal.id }}">
                <div class="avatar-info">
                    <div class="avatar-hp-bar">
                        <div class="avatar-hp-fill" id="hp-bar-L{{ heal.id }}" style="width:100%"><span class="avatar-hp" id="hp-L{{ heal.id }}">{{ heal.HP }}</span></div>
                    </div>
                </div>
                <img src="{{ asset('uploads/images/' ~ heal.imageName) }}" alt="{{ heal.name }}" class="avatar" title="{{ heal.name }}">
                {% if equipped_weapons[heal.id] is defined %}
                    <img src="{{ asset('uploads/weapons/' ~ equipped_weapons[heal.id].imageName) }}" 
                         alt="{{ equipped_weapons[heal.id].name }}" 
                         class="weapon-icon" 
                         title="{{ equipped_weapons[heal.id].name }} (+{{ equipped_weapons[heal.id].power }} ATK, +{{ equipped_weapons[heal.id].defense }} DEF)">
                {% endif %}
            </div>
        {% endfor %}

        {# Team 2: tanks #}
        {% set tanks2 = opponent_team|filter(c => c.role and c.role.name|lower == 'tank') %}
        {% for tank in tanks2 %}
            <div class="avatar-container team2-tank{% if loop.index0 > 0 %} offset-{{ loop.index0 }}{% endif %}" id="char-R{{ tank.id }}">
                <div class="avatar-info">
                    <div class="avatar-hp-bar">
                        <div class="avatar-hp-fill" id="hp-bar-R{{ tank.id }}" style="width:100%"><span class="avatar-hp" id="hp-R{{ tank.id }}">{{ tank.HP }}</span></div>
                    </div>
                </div>
                <img src="{{ asset('uploads/images/' ~ tank.imageName) }}" alt="{{ tank.name }}" class="avatar" title="{{ tank.name }}">
            </div>
        {% endfor %}
        {# Team 2: dps #}
        {% set dps2 = opponent_team|filter(c => c.role and c.role.name|lower in ['dps','damage']) %}
        {% for dps in dps2 %}
            <div class="avatar-container team2-dps{% if loop.index0 > 0 %} offset-{{ loop.index0 }}{% endif %}" id="char-R{{ dps.id }}">
                <div class="avatar-info">
                    <div class="avatar-hp-bar">
                        <div class="avatar-hp-fill" id="hp-bar-R{{ dps.id }}" style="width:100%"><span class="avatar-hp" id="hp-R{{ dps.id }}">{{ dps.HP }}</span></div>
                    </div>
                </div>
                <img src="{{ asset('uploads/images/' ~ dps.imageName) }}" alt="{{ dps.name }}" class="avatar" title="{{ dps.name }}">
            </div>
        {% endfor %}
        {# Team 2: heals #}
        {% set heals2 = opponent_team|filter(c => c.role and c.role.name|lower in ['heal','healer']) %}
        {% for heal in heals2 %}
            <div class="avatar-container team2-heal{% if loop.index0 > 0 %} offset-{{ loop.index0 }}{% endif %}" id="char-R{{ heal.id }}">
                <div class="avatar-info">
                    <div class="avatar-hp-bar">
                        <div class="avatar-hp-fill" id="hp-bar-R{{ heal.id }}" style="width:100%"><span class="avatar-hp" id="hp-R{{ heal.id }}">{{ heal.HP }}</span></div>
                    </div>
                </div>
                <img src="{{ asset('uploads/images/' ~ heal.imageName) }}" alt="{{ heal.name }}" class="avatar" title="{{ heal.name }}">
            </div>
        {% endfor %}
    </div>
    <div class="battle-controls">
        <button id="play-battle" class="match-btn">Jouer</button>
        <button id="pause-battle" class="match-btn">Pause</button>
    </div>
    
    <div class="battle-info">
        <div class="round-counter">
            <span id="round-counter">Round: 0</span>
        </div>
        <div class="battle-log-section">
            <h3 class="log-title">Journal du combat</h3>
            <div id="battle-log" class="battle-log"></div>
            <div id="battle-winner" class="battle-winner" 
                data-winner="{{ result.winnerTeamId is defined ? result.winnerTeamId : '' }}"
                data-opponent-name="{{ opponent.username }}"></div>
        </div>
    </div>
</div>

<!-- Hidden data for JavaScript -->
<script type="application/json" id="battle-setup-data">{{ setup|json_encode|raw }}</script>
<script type="application/json" id="battle-frames-data">{{ frames|json_encode|raw }}</script>
<script type="application/json" id="battle-unit-map-data">{{ unit_map|json_encode|raw }}</script>
<script type="application/json" id="battle-unit-owners-data">{{ unit_owners|json_encode|raw }}</script>

<style>
    .glow-left { box-shadow: 0 0 18px 6px rgba(0,150,255,0.35); background: #e8f6ff; }
    .glow-right { box-shadow: 0 0 18px 6px rgba(255,80,80,0.25); background: #fff0f0; }
    .glow-action { box-shadow: 0 0 12px 4px rgba(0,0,0,0.12); }
    /* When a unit is targeted, scale up a bit less */
    .targeted { transform: scale(1.04); z-index: 4; transition: transform 220ms ease; }
    /* Heal visual - both healer and healed turn green briefly */
    .heal { box-shadow: 0 0 18px 6px rgba(60,180,80,0.25); background: #eefdf0; }
    .dead { opacity: 0.5; filter: grayscale(1); }
</style>

{% endblock %}
